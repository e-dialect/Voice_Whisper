<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SenseVoice - ä½èµ„æºè¯­éŸ³å¤„ç†å·¥å…·åŒ…</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- æ·»åŠ jQueryåº“å¼•ç”¨ -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4895ef;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --border-radius: 12px;
        }

        body {
            padding: 0;
            background-color: #f0f2f5;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .app-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
            border-bottom: 5px solid var(--accent-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

       /* é¡µé¢é¡¶éƒ¨ç¾åŒ– */
.app-header {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    padding: 2.5rem 0;
    margin-bottom: 2.5rem;
    border-bottom: 5px solid var(--accent-color);
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
}

/* ä¸»æ ‡é¢˜ç¾åŒ– */
.app-title {
    font-family: "Microsoft YaHei", "PingFang SC", sans-serif;
    font-weight: 700;
    font-size: 3rem;
    margin-bottom: 1rem;
    letter-spacing: 0.05em;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

/* ä¸»æ ‡é¢˜è£…é¥°çº¿ */
.app-title::after {
    content: "";
    display: block;
    width: 80px;
    height: 3px;
    background: rgba(255, 255, 255, 0.8);
    margin: 8px auto 0;
    border-radius: 2px;
}

/* ç¬¬ä¸€ä¸ªå‰¯æ ‡é¢˜ - çªå‡ºæ˜¾ç¤º */
.app-subtitle:first-of-type {
    font-size: 1.4rem;
    font-weight: 500;
    margin-bottom: 0.8rem;
    letter-spacing: 0.03em;
}

/* ç¬¬äºŒä¸ªå‰¯æ ‡é¢˜ - å·®å¼‚åŒ–æ ·å¼ */
.app-subtitle:last-child {
    font-size: 1.1rem;
    font-weight: 300;
    opacity: 0.9;
    padding: 6px 20px;
    background-color: rgba(255, 255, 255, 0.15);
    border-radius: 30px;
    display: inline-block;
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 768px) {
    .app-title {
        font-size: 2.2rem;
    }
    .app-subtitle:first-of-type {
        font-size: 1.2rem;
    }
    .app-subtitle:last-child {
        font-size: 0.9rem;
    }
}

        .content-wrapper {
        display: flex;
        flex: 1;
        max-width: 1800px; /* å¢åŠ æœ€å¤§å®½åº¦ä»¥é€‚åº”ä¸‰åˆ— */
        margin: 0 auto 2rem;
        padding: 0 15px;
        gap: 20px; /* åˆ—ä¹‹é—´çš„é—´éš” */
    }
    .panel-column {
        flex: 1;
        min-width: 0; /* å…è®¸æ”¶ç¼© */
    }
        .left-panel {
            flex: 1;
            margin-right: 1rem;
            min-width: 0;
        }

        .right-panel {
            flex: 1;
            margin-left: 1rem;
            min-width: 0;
        }

        .panel-container {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .panel-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid rgba(67, 97, 238, 0.2);
        }

        .card {
            border: none;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .card-header {
            background-color: rgba(67, 97, 238, 0.1);
            color: var(--primary-color);
            font-weight: 600;
            border-top-left-radius: var(--border-radius) !important;
            border-top-right-radius: var(--border-radius) !important;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .upload-section {
            background: linear-gradient(to right, #ffffff, #f9f9f9);
            border: 2px dashed #dee2e6;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: var(--primary-color);
        }

        .upload-icon {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 0.75rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            border-radius: 30px;
            padding: 0.5rem 1.5rem;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .progress {
            height: 10px;
            border-radius: 5px;
            background-color: #e9ecef;
            margin: 1rem 0;
        }

        .progress-bar {
            background-color: var(--primary-color);
            border-radius: 5px;
        }

        .speaker-section {
            margin-top: 1.5rem;
            padding: 1.25rem;
            border-radius: var(--border-radius);
            border: 1px solid rgba(0, 0, 0, 0.1);
            background-color: #fbfbfb;
            transition: all 0.3s ease;
        }

        .speaker-section:hover {
            border-color: var(--accent-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .segment-item {
            background-color: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #eee;
            transition: all 0.3s ease;
            position: relative;
        }

        .segment-item:hover {
            border-color: var(--accent-color);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }

        .segment-item audio {
            width: 100%;
            margin: 0.5rem 0;
            border-radius: 8px;
        }

        .recognized-text {
            background-color: #f8f9fa;
            border-left: 4px solid var(--primary-color);
            padding: 1rem;
            border-radius: 0 8px 8px 0;
            font-size: 1.1rem;
            line-height: 1.6;
            max-height: 300px;
            overflow-y: auto;
        }

        .speaker-badge {
            background-color: var(--primary-color);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-right: 0.5rem;
            display: inline-block;
        }

        .model-badge {
            background-color: rgba(67, 97, 238, 0.1);
            color: var(--primary-color);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
        }

        .time-badge {
            background-color: #e9ecef;
            color: #495057;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .hidden {
            display: none;
        }

        /* ä¸ºéŸ³é¢‘æ’­æ”¾å™¨æ·»åŠ è‡ªå®šä¹‰æ ·å¼ */
        audio {
            border-radius: 30px;
            background-color: #f8f9fa;
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .speakers-container {
            max-height: calc(100vh - 300px);
            overflow-y: auto;
            padding-right: 10px;
        }

        .speakers-container::-webkit-scrollbar {
            width: 8px;
        }

        .speakers-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .speakers-container::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 10px;
        }

        .speakers-container::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        /* æƒ…æ„Ÿæ ‡è®°æ ·å¼ */
        .emotion-badge {
            font-size: 1.5rem;
            vertical-align: middle;
        }

        .event-badge {
            font-size: 1.5rem;
            vertical-align: middle;
        }

        /* æƒ…æ„Ÿæ°”æ³¡æ•ˆæœ */
        .segment-item {
            position: relative;
        }

        .segment-item .emotion-badge {
            position: relative;
            transition: all 0.3s ease;
        }

        .segment-item:hover .emotion-badge {
            transform: scale(1.5);
        }

        /* è¯´è¯äººæƒ…æ„Ÿç»Ÿè®¡æ ·å¼ */
        .speaker-emotions {
            display: flex;
            align-items: center;
        }

        .main-emotion {
            font-size: 1.8rem;
            margin-right: 8px;
        }

        .emotion-stats {
            display: flex;
            gap: 4px;
        }

        .emotion-stat {
            font-size: 1.2rem;
            opacity: 0.7;
            transition: all 0.2s ease;
        }

        .emotion-stat:hover {
            opacity: 1;
            transform: scale(1.2);
        }

        /* ç°æœ‰æ ·å¼... */

        .emotion-emoji {
            font-size: 1.5rem;
            vertical-align: middle;
            transition: all 0.3s ease;
        }

        .emotion-emoji:hover {
            transform: scale(1.5);
            cursor: help;
        }

        .event-emoji {
            font-size: 1.3rem;
            vertical-align: middle;
        }

        /* æƒ…æ„Ÿè‰²å½©æç¤º */
        .segment-item {
            border-left: 4px solid transparent;
            transition: border-color 0.3s ease;
        }

        /* æ ¹æ®ä¸åŒæƒ…æ„Ÿè®¾ç½®ä¸åŒè¾¹æ¡†é¢œè‰² */
        .segment-item[data-emotion="ğŸ˜Š"] {
            border-left-color: #4caf50;
            /* å¼€å¿ƒ-ç»¿è‰² */
        }

        .segment-item[data-emotion="ğŸ˜¡"] {
            border-left-color: #f44336;
            /* ç”Ÿæ°”-çº¢è‰² */
        }

        .segment-item[data-emotion="ğŸ˜”"] {
            border-left-color: #2196f3;
            /* ä¼¤å¿ƒ-è“è‰² */
        }

        .segment-item[data-emotion="ğŸ˜®"] {
            border-left-color: #ff9800;
            /* æƒŠè®¶-æ©™è‰² */
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 1200px) {
        .content-wrapper {
            flex-direction: column;
        }
        
        .panel-column {
            width: 100%;
            margin-bottom: 20px;
        }
            .left-panel,
            .right-panel {
                width: 100%;
                margin: 0 0 1.5rem 0;
            }
        }

        @media (max-width: 768px) {
            .app-title {
                font-size: 1.8rem;
            }

            .panel-container {
                padding: 1rem;
            }
        }

        footer {
            margin-top: auto;
        }

        .emotion-large {
            font-size: 2.5rem;
            line-height: 1;
        }

        .emotion-stat-item {
            transition: all 0.3s ease;
        }

        .emotion-stat-item:hover {
            transform: translateY(-5px);
        }

        /* æ·»åŠ å·¥å…·å¯¼èˆªåŒºæ ·å¼ */
        .tools-nav {
            padding: 2rem 0;
            background-color: #f8f9fa;
            margin: -2rem 0 2rem;
            border-bottom: 1px solid #eee;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .tool-card {
            height: 100%;
            transition: all 0.3s;
        }

        .tool-card:hover {
            transform: translateY(-10px);
        }

        .tool-icon {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
    </style>
</head>

<body>
    <!-- é¡µé¢é¡¶éƒ¨ -->
    <header class="app-header text-center">
        <h1 class="app-title">å¾®è¯­ä¹‹å£°</h1>
        <p class="app-subtitle">ä½èµ„æºè¯­éŸ³å¤„ç†å·¥å…·åŒ…</p>
        <p class="app-subtitle">æ”¯æŒæ–¹è¨€è¯†åˆ«ã€è¯´è¯äººåˆ†ç¦»ã€æƒ…æ„Ÿæ£€æµ‹ä¸è¯­éŸ³å…‹éš†</p>
    </header>

    <!-- å·¥å…·å¯¼èˆªåŒº - æ–°å¢ -->
    <div class="tools-nav">
        <div class="container">
            <div class="row justify-content-center">
                <!-- è¯­éŸ³è¯†åˆ«å·¥å…·å¡ç‰‡ -->
                <div class="col-md-4 mb-4">
                    <div class="card tool-card h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-microphone fa-3x mb-3 tool-icon"></i>
                            <h5 class="card-title">è¯­éŸ³è¯†åˆ«ä¸åˆ†ç¦»</h5>
                            <p class="card-text">ä¸Šä¼ éŸ³é¢‘ï¼Œè¯†åˆ«è¯­éŸ³å†…å®¹å¹¶åˆ†ç¦»è¯´è¯äºº</p>
                            <a href="#uploadForm" class="btn btn-primary">
                                <i class="fas fa-arrow-down me-1"></i>å¼€å§‹ä½¿ç”¨
                            </a>
                        </div>
                    </div>
                </div>

                <!-- å£°éŸ³å…‹éš†å·¥å…·å¡ç‰‡ -->
                <div class="col-md-4 mb-4">
                    <div class="card tool-card h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-clone fa-3x mb-3 tool-icon"></i>
                            <h5 class="card-title">å£°éŸ³å…‹éš†</h5>
                            <p class="card-text">ä½¿ç”¨å‚è€ƒéŸ³é¢‘å…‹éš†è¯´è¯äººå£°éŸ³è¿›è¡Œåˆæˆ</p>
                            <a href="#cloneSection" class="btn btn-primary">
                                <i class="fas fa-arrow-down me-1"></i>æŸ¥çœ‹å…‹éš†
                            </a>
                        </div>
                    </div>
                </div>

                <!-- é™å™ªå·¥å…·å¡ç‰‡ -->
                <div class="col-md-4 mb-4">
                    <div class="card tool-card h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-filter fa-3x mb-3 tool-icon"></i>
                            <h5 class="card-title">éŸ³é¢‘é™å™ª</h5>
                            <p class="card-text">å»é™¤èƒŒæ™¯å™ªéŸ³ã€æ··å“å’Œå›éŸ³ï¼Œæé«˜å£°éŸ³æ¸…æ™°åº¦</p>
                            <a href="/denoise_page" class="btn btn-primary">
                                <i class="fas fa-arrow-right me-1"></i>å‰å¾€é™å™ªå·¥å…·
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å·¦å³åˆ†å¸ƒçš„ä¸»å†…å®¹åŒº -->
    <div class="content-wrapper">
        <!-- å·¦ä¾§é¢æ¿ï¼šä¸Šä¼ å’Œè¯†åˆ«ç»“æœ -->
        <div class="left-panel">
            <div class="panel-container">
                <h2 class="panel-title"><i class="fas fa-microphone-alt me-2"></i>éŸ³é¢‘ä¸Šä¼ ä¸è¯†åˆ«ç»“æœ</h2>

                <!-- ä¸Šä¼ éƒ¨åˆ† -->
                <div class="upload-section mb-4" id="uploadForm">
                    <i class="fas fa-cloud-upload-alt upload-icon"></i>
                    <h3 class="mb-3">ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶</h3>
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <input type="file" class="form-control" id="audioFile" name="file"
                                accept=".mp3,.m4a,.aac,.ogg,.wav,.flac,.wma,.aif,.mp4,.avi,.mov,.mkv">
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="modelSelect" class="form-label">é€‰æ‹©è¯†åˆ«æ¨¡å‹</label>
                                <select class="form-select" id="modelSelect" name="model">
                                    <!-- é€šè¿‡JSåŠ¨æ€å¡«å…… -->
                                </select>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="splitNumber" class="form-label">åˆ†æ®µå­—æ•°è®¾ç½®</label>
                                <input type="number" class="form-control" id="splitNumber" name="split_number" min="5"
                                    max="50" value="20">
                            </div>
                        </div>

                        <!-- æ·»åŠ é™å™ªé€‰é¡¹ -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enableDenoise"
                                        name="enable_denoise">
                                    <label class="form-check-label" for="enableDenoise">
                                        <i class="fas fa-filter me-2"></i>å¯ç”¨éŸ³é¢‘é™å™ª
                                    </label>
                                </div>
                            </div>
                            <div class="card-body" id="denoiseOptions" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <label for="denoiseModel" class="form-label">é™å™ªæ¨¡å‹</label>
                                        <select class="form-select form-select-sm" id="denoiseModel"
                                            name="denoise_model">
                                            <option value="HP5" selected>äººå£°ä¼˜åŒ– (æ ‡å‡†)</option>
                                            <option value="VR-DeEcho-DeReverb">å»æ··å“ä¸å›éŸ³</option>
                                            <option value="VR-DeEcho">ä»…å»å›éŸ³</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <label for="denoiseLevel" class="form-label">é™å™ªå¼ºåº¦</label>
                                        <div class="d-flex align-items-center">
                                            <input type="range" class="form-range me-2" id="denoiseLevel"
                                                name="denoise_level" min="0" max="20" value="10">
                                            <span id="denoiseLevelValue">10</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-text text-muted">
                                    <i class="fas fa-info-circle"></i>
                                    é™å™ªå°†åœ¨éŸ³é¢‘ä¸Šä¼ åè‡ªåŠ¨å¤„ç†ï¼Œè¯†åˆ«å°†ä½¿ç”¨é™å™ªåçš„éŸ³é¢‘
                                </div>
                            </div>
                        </div>

                        <div id="previewContainer" class="mb-3" style="display:none;">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-play-circle me-2"></i>éŸ³é¢‘é¢„è§ˆ
                                </div>
                                <div class="card-body">
                                    <audio id="audioPreview" controls></audio>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-cloud-upload-alt me-2"></i>å¼€å§‹è¯†åˆ«
                        </button>
                    </form>
                </div>

                <!-- å¤„ç†ä¸­çŠ¶æ€ -->
                <div class="progress-container hidden card" id="progressContainer">
                    <div class="card-header">
                        <i class="fas fa-spinner fa-spin me-2"></i>å¤„ç†ä¸­
                    </div>
                    <div class="card-body">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%">
                            </div>
                        </div>
                        <p class="text-center mt-3" id="progressText">æ­£åœ¨å¤„ç†ï¼Œè¯·ç¨å€™...</p>
                    </div>
                </div>

                <!-- é”™è¯¯æç¤º -->
                <div class="alert alert-danger hidden mt-4" id="errorContainer">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle me-3" style="font-size: 1.5rem;"></i>
                        <p class="mb-0" id="errorMessage"></p>
                    </div>
                </div>

                <!-- è¯†åˆ«ç»“æœæ–‡æœ¬ -->
                <div class="result-text-container hidden fade-in" id="resultTextContainer">
                    <div class="alert alert-success" id="successMessage"></div>

                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-check-circle me-2"></i>è¯†åˆ«ç»“æœ</span>
                            <div class="model-badge" id="modelBadge"></div>
                        </div>
                        <div class="card-body">
                            <h4>è¯†åˆ«æ–‡æœ¬</h4>
                            <div class="recognized-text" id="recognizedText"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§é¢æ¿ï¼šè¯´è¯äººåˆ†ç¦»ç»“æœ -->
        <div class="right-panel">
            <div class="panel-container">
                <h2 class="panel-title"><i class="fas fa-users me-2"></i>è¯´è¯äººåˆ†ç¦»ç»“æœ</h2>

                <!-- è¯´è¯äººåˆ†ç¦»ç»“æœ -->
                <div class="speakers-container hidden fade-in" id="speakersResultContainer">
                    <div id="speakersContainer"></div>
                </div>

                <!-- æœªå¼€å§‹è¯†åˆ«çŠ¶æ€ -->
                <div class="text-center py-5" id="noResultsMessage">
                    <i class="fas fa-microphone-slash text-muted" style="font-size: 3rem;"></i>
                    <p class="mt-3 text-muted">ä¸Šä¼ éŸ³é¢‘å¹¶ç‚¹å‡»è¯†åˆ«æŒ‰é’®ï¼Œ<br>æŸ¥çœ‹è¯´è¯äººåˆ†ç¦»ç»“æœ</p>
                </div>

                <!-- æƒ…æ„Ÿç»Ÿè®¡éƒ¨åˆ† -->
                <div class="emotion-summary mb-4 fade-in hidden" id="emotionSummaryContainer">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-pie me-2"></i>æƒ…æ„Ÿåˆ†å¸ƒç»Ÿè®¡
                        </div>
                        <div class="card-body">
                            <div id="emotionSummary" class="d-flex flex-wrap justify-content-center"></div>
                        </div>
                    </div>
                </div>

                
            </div>
        </div>
        <div class="panel-column">
            <div class="panel-container">
                <h2 class="panel-title"><i class="fas fa-clone me-2"></i>å£°éŸ³å…‹éš†</h2>
        
                <!-- å£°éŸ³å…‹éš†éƒ¨åˆ† -->
                <div id="cloneSection" style="display: none;">
                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        ä½¿ç”¨è¯´è¯äººå£°éŸ³åˆæˆæ‚¨æŒ‡å®šçš„æ–‡æœ¬å†…å®¹
                    </div>
        
                    <div class="mb-3">
                        <label for="cloneText" class="form-label">è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬:</label>
                        <textarea class="form-control" id="cloneText" rows="3" placeholder="è¯·è¾“å…¥è¦ç”¨é€‰å®šè¯´è¯äººå£°éŸ³åˆæˆçš„æ–‡æœ¬..."></textarea>
                    </div>
        
                    <div class="mb-3">
                        <label class="form-label">é€‰æ‹©å£°éŸ³æ¥æº:</label>
                        <div class="d-flex align-items-center">
                            <select class="form-select me-2" id="cloneSpeaker">
                                <option value="" disabled selected>è¯·å…ˆä¸Šä¼ éŸ³é¢‘å¹¶è¯†åˆ«...</option>
                            </select>
                            <button class="btn btn-sm btn-outline-secondary" id="previewSpeakerVoice">
                                <i class="fas fa-play me-1"></i>è¯•å¬
                            </button>
                        </div>
                    </div>
        
                    <button class="btn btn-primary" id="cloneButton">
                        <i class="fas fa-clone me-1"></i> å¼€å§‹å…‹éš†
                    </button>
        
                    <!-- å…‹éš†ç»“æœåŒºåŸŸ -->
                    <div class="card mt-3" id="cloneResult" style="display: none;">
                        <div class="card-body">
                            <h6><i class="fas fa-check-circle me-2 text-success"></i>å…‹éš†ç»“æœ:</h6>
                            <div class="d-flex align-items-center">
                                <audio id="clonedAudio" controls class="w-100 me-2"></audio>
                                <button class="btn btn-sm btn-outline-secondary" id="downloadCloned">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </div>
                    </div>
        
                    <!-- å…‹éš†å¤„ç†ä¸­çŠ¶æ€ -->
                    <div class="card mt-3" id="cloneProcessing" style="display: none;">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border text-primary me-3" role="status">
                                    <span class="visually-hidden">å¤„ç†ä¸­...</span>
                                </div>
                                <div>
                                    <h6 class="mb-0">æ­£åœ¨å¤„ç†å£°éŸ³å…‹éš†...</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
        
                <!-- æœªä¸Šä¼ éŸ³é¢‘æ—¶æ˜¾ç¤ºçš„æç¤º -->
                <div id="cloneEmptyState">
                    <div class="text-center py-5">
                        <i class="fas fa-microphone-alt text-muted" style="font-size: 3rem;"></i>
                        <h5 class="mt-3">å®Œæˆè¯´è¯äººåˆ†ç¦»åï¼Œ<br>å¯ä»¥ä½¿ç”¨é€‰å®šè¯´è¯äººçš„å£°éŸ³è¿›è¡Œå…‹éš†</h5>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-light py-3 text-center">
        <p class="mb-0">Â© 2025 SenseVoice - å¼ºå¤§çš„æ–¹è¨€è¯†åˆ«ä¸è¯´è¯äººåˆ†ç¦»ç³»ç»Ÿ</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // é¡µé¢åŠ è½½æ—¶è·å–æ¨¡å‹åˆ—è¡¨
        window.addEventListener('DOMContentLoaded', function () {
            fetch('/models')
                .then(response => response.json())
                .then(data => {
                    const modelSelect = document.getElementById('modelSelect');
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.textContent = model.name;
                        option.selected = model.default;
                        modelSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
                });
        });

        // æ§åˆ¶é™å™ªé€‰é¡¹çš„æ˜¾ç¤ºå’Œéšè—
        document.getElementById('enableDenoise').addEventListener('change', function (e) {
            const denoiseOptions = document.getElementById('denoiseOptions');
            if (this.checked) {
                denoiseOptions.style.display = 'block';
            } else {
                denoiseOptions.style.display = 'none';
            }
        });

        // æ˜¾ç¤ºé™å™ªçº§åˆ«å€¼
        document.getElementById('denoiseLevel').addEventListener('input', function (e) {
            document.getElementById('denoiseLevelValue').textContent = this.value;
        });

        document.getElementById('uploadForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const fileInput = document.getElementById('audioFile');
            if (!fileInput.files.length) {
                showError('è¯·é€‰æ‹©æ–‡ä»¶');
                return;
            }

            // æ˜¾ç¤ºè¿›åº¦
            document.getElementById('progressContainer').classList.remove('hidden');
            document.getElementById('resultTextContainer').classList.add('hidden');
            document.getElementById('errorContainer').classList.add('hidden');
            document.getElementById('noResultsMessage').classList.add('hidden');
            document.getElementById('speakersResultContainer').classList.add('hidden');

            // åˆ›å»ºFormDataå¯¹è±¡
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('split_number', document.getElementById('splitNumber').value);
            formData.append('model', document.getElementById('modelSelect').value);

            // æ·»åŠ é™å™ªå‚æ•°
            const enableDenoise = document.getElementById('enableDenoise').checked;
            formData.append('enable_denoise', enableDenoise);

            if (enableDenoise) {
                formData.append('denoise_model', document.getElementById('denoiseModel').value);
                formData.append('denoise_level', document.getElementById('denoiseLevel').value);
            }

            // æ›´æ–°è¿›åº¦æ–‡æœ¬
            const progressText = document.getElementById('progressText');
            if (enableDenoise) {
                progressText.textContent = 'æ­£åœ¨ä¸Šä¼ å¹¶è¿›è¡Œé™å™ªå¤„ç†ï¼Œè¯·ç¨å€™...';
            } else {
                progressText.textContent = 'æ­£åœ¨å¤„ç†ï¼Œè¯·ç¨å€™...';
            }

            // å‘é€è¯·æ±‚
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('progressContainer').classList.add('hidden');

                    if (data.status === 'success') {
                        showResult(data);
                    } else {
                        showError(data.message);
                    }
                })
                .catch(error => {
                    document.getElementById('progressContainer').classList.add('hidden');
                    showError('å¤„ç†è¯·æ±‚å¤±è´¥: ' + error);
                });
        });

        // æ–‡ä»¶é€‰æ‹©å˜åŒ–æ—¶é¢„è§ˆéŸ³é¢‘
        document.getElementById('audioFile').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æ˜¯éŸ³é¢‘æ–‡ä»¶
            const audioFormats = ['.mp3', '.m4a', '.aac', '.ogg', '.wav', '.flac', '.wma', '.aif'];
            const videoFormats = ['.mp4', '.avi', '.mov', '.mkv'];
            const fileExt = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();

            if (audioFormats.includes(fileExt) || videoFormats.includes(fileExt)) {
                const audioPreview = document.getElementById('audioPreview');
                const previewContainer = document.getElementById('previewContainer');

                // åˆ›å»ºä¸´æ—¶URLå¹¶è®¾ç½®ç»™audioå…ƒç´ 
                audioPreview.src = URL.createObjectURL(file);
                previewContainer.style.display = 'block';
            }
        });

        // å£°éŸ³å…‹éš†ç›¸å…³å‡½æ•°
        function setupCloneUI(speakers, date, audioName) {
                // å…ˆè·å–å…ƒç´ å¼•ç”¨
                const cloneEmptyState = document.getElementById('cloneEmptyState');
                const cloneSection = document.getElementById('cloneSection');

                // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
                if (!cloneEmptyState || !cloneSection) {
                    console.error('å£°éŸ³å…‹éš†ç•Œé¢å…ƒç´ æœªæ‰¾åˆ°:', {
                        'cloneEmptyStateå­˜åœ¨': !!cloneEmptyState,
                        'cloneSectionå­˜åœ¨': !!cloneSection
                    });
                    return; // å¦‚æœå…ƒç´ ä¸å­˜åœ¨ï¼Œé€€å‡ºå‡½æ•°
                }

                // ç¡®è®¤å…ƒç´ å­˜åœ¨åå†æ“ä½œ
                cloneEmptyState.style.display = 'none';
                cloneSection.style.display = 'block';

                // é‡ç½®ç»“æœåŒºåŸŸ
                document.getElementById('cloneResult').style.display = 'none';
                document.getElementById('cloneProcessing').style.display = 'none';


                // æ¸…ç©ºå¹¶å¡«å……è¯´è¯äººé€‰æ‹©å™¨
                const speakerSelect = document.getElementById('cloneSpeaker');
                speakerSelect.innerHTML = '';

                // å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°è¯´è¯äººï¼Œæ·»åŠ æç¤ºé€‰é¡¹
                if (!speakers || speakers.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'æœªæ£€æµ‹åˆ°è¯´è¯äºº';
                    option.disabled = true;
                    speakerSelect.appendChild(option);
                    return;
                }

                // æ·»åŠ æ‰€æœ‰è¯´è¯äººé€‰é¡¹
                speakers.forEach(spk => {
                    const option = document.createElement('option');
                    option.value = spk;
                    option.textContent = `è¯´è¯äºº ${spk}`;
                    speakerSelect.appendChild(option);
                });

                // è¯•å¬æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                document.getElementById('previewSpeakerVoice').onclick = function () {
                    const speakerId = speakerSelect.value;
                    if (!speakerId) return;

                    // æŸ¥æ‰¾å½“å‰é€‰ä¸­è¯´è¯äººçš„ç¬¬ä¸€ä¸ªéŸ³é¢‘ç‰‡æ®µå¹¶æ’­æ”¾
                    const audioElements = document.querySelectorAll(`#speaker-${speakerId}-segments audio`);
                    if (audioElements.length > 0) {
                        audioElements[0].play();
                    }
                };

                // ç»‘å®šå…‹éš†æŒ‰é’®äº‹ä»¶
                document.getElementById('cloneButton').onclick = function () {
                    const text = document.getElementById('cloneText').value;
                    const speakerId = speakerSelect.value;

                    if (!text) {
                        alert('è¯·è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬');
                        return;
                    }

                    // æ˜¾ç¤ºå¤„ç†ä¸­çŠ¶æ€
                    document.getElementById('cloneButton').disabled = true;
                    document.getElementById('cloneProcessing').style.display = 'block';
                    document.getElementById('cloneResult').style.display = 'none';

                    // å‘é€å…‹éš†è¯·æ±‚
                    fetch('/clone', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            speaker_id: speakerId,
                            text: text,
                            date: date,
                            audio_name: audioName
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById('cloneProcessing').style.display = 'none';
                            document.getElementById('cloneButton').disabled = false;

                            if (data.status === 'success') {
                                // æ˜¾ç¤ºç»“æœ
                                document.getElementById('cloneResult').style.display = 'block';
                                document.getElementById('clonedAudio').src = data.audio_url;
                                document.getElementById('clonedAudio').play();

                                // è®¾ç½®ä¸‹è½½é“¾æ¥
                                document.getElementById('downloadCloned').onclick = function () {
                                    const downloadLink = document.createElement('a');
                                    downloadLink.href = data.audio_url;
                                    downloadLink.download = `å…‹éš†è¯­éŸ³_${speakerId}.wav`;
                                    document.body.appendChild(downloadLink);
                                    downloadLink.click();
                                    document.body.removeChild(downloadLink);
                                };
                            } else {
                                alert('å£°éŸ³å…‹éš†å¤±è´¥: ' + data.message);
                            }
                        })
                        .catch(error => {
                            document.getElementById('cloneProcessing').style.display = 'none';
                            document.getElementById('cloneButton').disabled = false;
                            alert('è¯·æ±‚å¤±è´¥: ' + error);
                        });
                };
            }

        function showResult(data) {
            // æ˜¾ç¤ºè¯†åˆ«æ–‡æœ¬ç»“æœ
            document.getElementById('resultTextContainer').classList.remove('hidden');
            document.getElementById('successMessage').textContent = data.message;

            if (data.model) {
                document.getElementById('modelBadge').textContent = 'ä½¿ç”¨æ¨¡å‹: ' + data.model;
            }

            document.getElementById('recognizedText').textContent = data.text;

            // æ˜¾ç¤ºè¯´è¯äººåˆ†ç¦»ç»“æœ
            document.getElementById('speakersResultContainer').classList.remove('hidden');
            document.getElementById('noResultsMessage').classList.add('hidden');

            // åˆ›å»ºè¯´è¯äººéƒ¨åˆ†
            const speakersContainer = document.getElementById('speakersContainer');
            speakersContainer.innerHTML = '';

            // æŒ‰è¯´è¯äººåˆ†ç»„æ˜¾ç¤ºæ‰€æœ‰ç‰‡æ®µ
            if (data.segments && Array.isArray(data.segments)) {
                data.segments.sort((a, b) => a.start.localeCompare(b.start));
            }

            // åˆ›å»ºä¸€ä¸ªç”¨äºå­˜å‚¨æ‰€æœ‰è¯´è¯äººIDçš„é›†åˆ
            let allSpeakers = new Set();

            // ç¡®ä¿ä»segmentsä¸­æ”¶é›†æ‰€æœ‰è¯´è¯äººID
            if (data.segments && Array.isArray(data.segments)) {
                data.segments.forEach(segment => {
                    if (segment && segment.spk !== undefined) {
                        allSpeakers.add(segment.spk);
                    }
                });
            }

            // å¦‚æœspeakersæ•°ç»„å­˜åœ¨ï¼Œå°†å…¶ä¸­çš„è¯´è¯äººä¹ŸåŠ å…¥é›†åˆ
            if (data.speakers && Array.isArray(data.speakers)) {
                data.speakers.forEach(speaker => {
                    allSpeakers.add(speaker);
                });
            }

            // å°†é›†åˆè½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
            const speakersList = Array.from(allSpeakers).sort((a, b) => Number(a) - Number(b));

            let speakerSections = {};

            // ä¸ºæ¯ä¸ªè¯´è¯äººåˆ›å»ºä¸€ä¸ªéƒ¨åˆ†
            speakersList.forEach(speaker => {
                const speakerDiv = document.createElement('div');
                speakerDiv.className = 'speaker-section mb-4';
                speakerDiv.innerHTML = `
                    <div class="d-flex align-items-center mb-3">
                        <div class="speaker-badge me-2">è¯´è¯äºº ${speaker}</div>
                        <div id="speaker-${speaker}-emotions" class="speaker-emotions mx-2"></div>
                        <div class="flex-grow-1 border-bottom"></div>
                    </div>
                    <div class="segments-container" id="speaker-${speaker}-segments"></div>
                `;
                speakersContainer.appendChild(speakerDiv);
                speakerSections[speaker] = document.getElementById(`speaker-${speaker}-segments`);
            });

            // ä¸ºæ¯ä¸ªç‰‡æ®µåˆ›å»ºä¸€ä¸ªéŸ³é¢‘æ’­æ”¾å™¨
            if (data.segments && Array.isArray(data.segments)) {
                data.segments.forEach(segment => {
                    if (segment && segment.url && segment.spk !== undefined) {
                        const segmentDiv = document.createElement('div');
                        segmentDiv.className = 'segment-item';

                        // æ·»åŠ æƒ…æ„Ÿå±æ€§ç”¨äºCSSæ ·å¼
                        if (segment.emotion) {
                            segmentDiv.setAttribute('data-emotion', segment.emotion);
                        }

                        segmentDiv.innerHTML = `
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <div>
                                    <span class="time-badge">${segment.start} - ${segment.end}</span>
                                    ${segment.events ? `<span class="event-emoji ms-2">${segment.events}</span>` : ''}
                                </div>
                                <div>
                                    <a href="${segment.url}" class="btn btn-sm btn-outline-primary" download>
                                        <i class="fas fa-download me-1"></i>ä¸‹è½½
                                    </a>
                                </div>
                            </div>
                            <audio controls src="${segment.url}" class="mb-2"></audio>
                            <p class="mb-0 p-2 bg-light rounded">
                                ${segment.text} 
                                ${segment.emotion ? `<span class="emotion-emoji ms-2" title="æƒ…æ„Ÿ">${segment.emotion}</span>` : ''}
                            </p>
                        `;

                        if (speakerSections[segment.spk]) {
                            speakerSections[segment.spk].appendChild(segmentDiv);
                        }
                    }
                });
            }

            // ä¸ºæ¯ä¸ªè¯´è¯äººç»Ÿè®¡æƒ…æ„Ÿåˆ†å¸ƒ
            updateSpeakerEmotions(data, speakersList);

            // ç¡®ä¿æƒ…æ„Ÿç»Ÿè®¡æ¡†ä¿æŒéšè—çŠ¶æ€
            const emotionSummaryContainer = document.getElementById('emotionSummaryContainer');
            if (emotionSummaryContainer) {
                emotionSummaryContainer.classList.add('hidden');
            }

          // åœ¨ç°æœ‰ä»£ç çš„æœ€åï¼Œæ·»åŠ åˆå§‹åŒ–å…‹éš†UIçš„è°ƒç”¨
            if (data.segments && data.segments.length > 0) {
                const speakersList = data.speakers || [];

                // è·å–éŸ³é¢‘è·¯å¾„ä¸­çš„æ—¥æœŸå’ŒéŸ³é¢‘åç§°ä¿¡æ¯
                // ç¤ºä¾‹è·¯å¾„: /audio/2025-06-01/recording_name/0/1.mp3
                const pathParts = data.segments[0].url.split('/');
                if (pathParts.length >= 4) {
                    const date = pathParts[2];
                    const audioName = pathParts[3];

                    // åˆå§‹åŒ–å…‹éš†UI
                    setupCloneUI(speakersList, date, audioName);
                }
            }
        }

        // ä¿®æ”¹ updateSpeakerEmotions å‡½æ•°
        function updateSpeakerEmotions(data, speakersList) {
            // å‚æ•°åŒ–æ•°æ®ï¼Œä¸å†ä¾èµ–å…¨å±€å˜é‡

            // ä¸ºæ¯ä¸ªè¯´è¯äººè®¡ç®—æƒ…æ„Ÿåˆ†å¸ƒ
            speakersList.forEach(speaker => {
                let emotionCounts = {};
                let totalEmotions = 0;

                // è®¡ç®—è¯¥è¯´è¯äººçš„æƒ…æ„Ÿé¢‘ç‡
                data.segments.forEach(segment => {
                    if (segment.spk == speaker && segment.emotion) {
                        emotionCounts[segment.emotion] = (emotionCounts[segment.emotion] || 0) + 1;
                        totalEmotions++;
                    }
                });

                // æ‰¾å‡ºä¸»è¦æƒ…æ„Ÿ
                let mainEmotion = '';
                let maxCount = 0;
                for (const [emotion, count] of Object.entries(emotionCounts)) {
                    if (count > maxCount) {
                        maxCount = count;
                        mainEmotion = emotion;
                    }
                }

                // æ˜¾ç¤ºæƒ…æ„Ÿç»Ÿè®¡
                const emotionContainer = document.getElementById(`speaker-${speaker}-emotions`);
                if (emotionContainer) {
                    let emotionHTML = '';

                    // æ·»åŠ ä¸»è¦æƒ…æ„Ÿ
                    if (mainEmotion) {
                        emotionHTML += `<span class="main-emotion" title="ä¸»è¦æƒ…æ„Ÿ">${mainEmotion}</span>`;
                    }

                    // æ·»åŠ æ‰€æœ‰æƒ…æ„Ÿç»Ÿè®¡
                    emotionHTML += '<div class="emotion-stats">';
                    for (const [emotion, count] of Object.entries(emotionCounts)) {
                        const percentage = Math.round((count / totalEmotions) * 100);
                        emotionHTML += `<span class="emotion-stat" title="${percentage}%">${emotion}</span>`;
                    }
                    emotionHTML += '</div>';

                    emotionContainer.innerHTML = emotionHTML;
                }
            });
        }

        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            const errorMessage = document.getElementById('errorMessage');

            errorContainer.classList.remove('hidden');
            errorMessage.textContent = message;
        }
    </script>
</body>

</html>